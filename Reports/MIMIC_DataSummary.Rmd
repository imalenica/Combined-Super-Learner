---
title: "MIMIC II Data Summary"
author: "Ivana Malenica and Rachael Phillips"
date: "September, 2019"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
header-includes:
- \usepackage{graphicx}
- \usepackage{lscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{float}
---

```{r setup, echo = FALSE}
options(warn=-1)
suppressMessages(library(xtable))
suppressMessages(library(here))
suppressMessages(library(tidyverse))
suppressMessages(library(data.table))
suppressMessages(library(dplyr))
suppressMessages(library(kableExtra))
suppressMessages(library(skimr))
options(xtable.comment = FALSE)
source(here::here("R", "utils_mimic.R"))
load(here::here("Data", "mimic_all.Rdata"))
```

# Overview of the Data

We only considered patients that had:

* at least 8 hours of data.

* at most 1 min time gap between two consecutive measurements. 

\vspace{.2in}

We can see a list of all the covariates available, as well as the basic summary 
statistic for each below. 

\vspace{.2in}
```{r, examine_data, echo=FALSE}
#Filter data so there is no more that 3 minute gap between observations.
#Subset data to samples that have at least 8 hours of data.
dat <- eval_missingness(min = 1, dataset = mimic_all, total_hrs = 8)[["dat"]] 
dat_summary <- dat[,c("abpsys","abpdias","abpmean","spo2", 
                      "imputed_abpmean","imputed_abpsys_abpdias","hypo_event",
                      "amine","sedation","ventilation","rank_icu","gender",
                      "age","sapsi_first","sofa_first","bmi","care_unit",
                      "admission_type_descr","imputed_age","imputed_bmi",
                      "imputed_sofa","imputed_sapsi")]
names(dat_summary)

#Summary of data:
# print(dfSummary(dat_summary), method = "render", display.labels=FALSE, headings=TRUE,
#       graph.col=TRUE, graph.magnif=0.8, silent=TRUE,
#       report.title="Summary of all the covariates")
```

\vspace{.2in}

We further explore the number of total hypotensive episodes experiences per each 
patient.

\vspace{.2in}

```{r, examine_data_2, results='asis', echo=FALSE}
dat$hypo_event <- as.numeric(levels(dat$hypo_event))[dat$hypo_event]

#Number of subjects with at least one event:
df <- dat %>%
  dplyr::select(c("subject_id", "hypo_event")) %>%
  dplyr::group_by(subject_id) %>%
  dplyr::mutate(sum_all_events = sum(hypo_event)) %>%
  dplyr::select(c("subject_id", "sum_all_events")) %>%
  dplyr::group_by(subject_id) %>%
  dplyr::summarize_all(unique)

#Summary of data:
# print(dfSummary(df[,2]), method = "render", display.labels=FALSE, headings=TRUE,
#       graph.col=TRUE, graph.magnif=0.8, silent=TRUE,
#       report.title="Summary of the sum of hypotensive events by patient")
```

Finally, we expore how many patients had at least one episode. 
442 of the 698 subjects experienced at least one hypotensive event, and the 
outcome function `Y1` was used to specify hypotensive events. By definition, 
an hypotensive episode is defined as a 5 minute window with mean arterial 
pressure (MAP) below 65 mmHg.

```{r, examine_data_3, results='asis', echo=FALSE}
#Samples with events:
sample_y1<-df[df$sum_all_events>0,1]
#Samples with no events:
sample_y0<-df[df$sum_all_events==0,1]

event_summary <- rbind.data.frame(dim(sample_y1)[1],
                                  dim(sample_y0)[1])
colnames(event_summary) <- "Number of Events"
row.names(event_summary) <- c("Samples with > 0 episodes",
                              "Samples with 0 episodes")

# print(dfSummary(event_summary), method = "render", display.labels=FALSE, headings=TRUE,
#       graph.col=TRUE, graph.magnif=0.8, silent=TRUE,
#       report.title="Summary of the sum of hypotensive events by patient")
```

# Data Used for the Combined Super Learner

```{r, prep_data, results='asis', echo=FALSE}
#Add the time column
dat <- dat %>%
  dplyr::group_by(subject_id) %>%
  dplyr::mutate(time = seq(1,n(), 1))

outcome <- "hypo_event"

covars_baseline <- c("gender","age","care_unit", "admission_type_descr", 
                     "sapsi_first", "sofa_first", "bmi", "rank_icu",
                     "imputed_age", "imputed_bmi", "imputed_sofa", 
                     "imputed_sapsi")

covars_timevarying <- c("amine", "sedation", "ventilation", "spo2", "hr", 
                        "abpmean", "imputed_abpmean")
```

Below we list covariates we use for the further analysis. In particular, we can 
classify them as follows:

1. Baseline Covariates

```{r, baseline, echo=FALSE, eval=TRUE}
covars_baseline
```

1.Time-varying Covariates

```{r, timevar, echo=FALSE, eval=TRUE}
covars_timevarying
```
