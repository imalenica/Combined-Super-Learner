---
title: "Combined Online SL for a collection of time-series"
author: "Ivana Malenica"
date: "Spring, 2019"
output:
  pdf_document:
    includes:
      in_header: header.sty
subparagraph: true
---

\section{Mock Trial: Comparison of different SLs based on the subset of data}

The below results summarize a test run comparing the Combined Online SL and Regular SL at various time points.
 
1. Combined Online SL: consists of both global and individualized learners, as well as various variations of the global learners that differentially adjust for baseline covariates.

2. Regular SL: just global SL.

The prediction is based on the following covariates:

1. "los_icu", "amine","sedation","ventilation","spo2","abpsys","abpdias","abpmean".

2. "gender","age","care_unit".

Initial training size included $n=1000$ samples, trained at $t=\{20, 30, 60, 90, 120, 150, 180, 240\}$ minutes. For each $t$, we follow a gap of $30$ minutes and predict the event for the following 30 minutes after the gap.

```{r, echo=FALSE}
#Load necessary libraries:
options(warn=-1)
suppressMessages(library(xtable))
suppressMessages(library(here))
suppressMessages(library(pROC))
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(reshape))
options(xtable.comment = FALSE)

#Load the data:
load(here("Results/TimeStep_t20.Rdata"))
res_t20<-x
load(here("Results/TimeStep_t30.Rdata"))
res_t30<-x
load(here("Results/TimeStep_t60.Rdata"))
res_t60<-x
load(here("Results/TimeStep_t90.Rdata"))
res_t90<-x
load(here("Results/TimeStep_t120.Rdata"))
res_t120<-x
load(here("Results/TimeStep_t150.Rdata"))
res_t150<-x
load(here("Results/TimeStep_t180.Rdata"))
res_t180<-x
load(here("Results/TimeStep_t240.Rdata"))
res_t240<-x
```


```{r, echo=FALSE}
#Some necessary calculations:

calculations = function(res){
  
  #Get all predictions in a data-frame:
  preds_fin<-as.data.frame(res$preds_fin)
  preds_regSL<-as.data.frame(res$pred_regular_SL)
  truth<-as.data.frame(res$truth)
  names(preds_regSL)<-names(preds_fin)
  names(truth)<-names(preds_fin)
  
  #preds_indSL<-as.data.frame(res$pred_regular_individual_SL)
  #names(preds_indSL)<-names(preds_fin)
  
  #Get all predictions in a data-frame:
  preds_fin<-as.data.frame(res$preds_fin)
  preds_regSL<-as.data.frame(res$pred_regular_SL)
  truth<-as.data.frame(res$truth)
  names(preds_regSL)<-names(preds_fin)
  names(truth)<-names(preds_fin)
  
  #preds_indSL<-as.data.frame(res$pred_regular_individual_SL)
  #names(preds_indSL)<-names(preds_fin)
  
  #AUC over ALL validation time-points
  pred_fin<-data.frame(pred=unlist(preds_fin))
  pred_regSL<-data.frame(pred=unlist(preds_regSL))
  truth<-data.frame(truth=unlist(truth))
  #pred_indSL<-data.frame(pred=unlist(preds_indSL))
  
  #(averaged over time and all samples):
  loss<-colMeans(res$losses_all)
  names(loss)<-names(res$losses_all)
  
  #Look at the weights as an average over all samples:
  weights<-as.data.frame(res$fit_coef)
  toDelete <- seq(1, dim(weights)[2], 2)
  weights <-  weights[,-toDelete]
  weight<-data.frame(rowMeans(weights))
  names(weight)<-"Coefficient"
  row.names(weight)<-res$fit_coef[[1]]$learners
  weight<-weight/sum(weight)
  #weight_lrn<-cbind.data.frame(Learner=res$fit_coef[[1]]$learners,Coefficients=weight)
  #weight<-weight_lrn[order(weight, decreasing = TRUE),1:2]  

  #Make a more general category:
  #1. picks the best algorithm from each category? 
  #2. averages over the algorithms?
  
  weight$SL_type<-NA
  weight[grepl("GlobalSL_screenbaseline", row.names(weight), fixed = TRUE),"SL_type"]<-"GlobalSL_Screen_Baseline"
  weight[grepl("GlobalSL_baseline", row.names(weight), fixed = TRUE),"SL_type"]<-"GlobalSL_Baseline"
  weight[grepl("GlobalSL_screen_", row.names(weight), fixed = TRUE),"SL_type"]<-"GlobalSL_Screen"
  weight[grepl("IndividualSL_", row.names(weight), fixed = TRUE),"SL_type"]<-"IndividualSL"
  weight[is.na(weight$SL_type),"SL_type"]<-"GlobalSL"
  
  #1. Best algorithm from each category
  max_SL_type <- weight %>% group_by(SL_type) %>% summarise(max=max(Coefficient))
  #2. Average of algorithms for each category
  ave_SL_type <- weight %>% group_by(SL_type) %>% summarise(ave=mean(Coefficient))

  return(list(pred_fin=pred_fin,
              pred_regSL=pred_regSL,
              truth=truth,
              loss=loss,
              weight=weight,
              max_SL_type=max_SL_type,
              ave_SL_type=ave_SL_type))
}

calc_t20<-calculations(res_t20)
calc_t30<-calculations(res_t30)
calc_t60<-calculations(res_t60)
calc_t90<-calculations(res_t90)
calc_t120<-calculations(res_t120)
calc_t150<-calculations(res_t150)
calc_t180<-calculations(res_t180)
calc_t240<-calculations(res_t240)

loss_all_t<-t(cbind.data.frame(calc_t20$loss,calc_t30$loss,calc_t60$loss,calc_t90$loss,calc_t120$loss,
                             calc_t150$loss,calc_t180$loss,calc_t240$loss))
row.names(loss_all_t)<-c("t=20","t=30","t=60","t=90","t=120","t=150","t=180","t=240")

```

```{r, echo=FALSE, eval=FALSE}
weight_all_max<-t(cbind.data.frame(calc_t20$max_SL_type[2],calc_t30$max_SL_type[2],calc_t60$max_SL_type[2],
                                   calc_t90$max_SL_type[2],calc_t120$max_SL_type[2],
                                   calc_t150$max_SL_type[2],calc_t180$max_SL_type[2],calc_t240$max_SL_type[2]))
row.names(weight_all_max)<-c("20","30","60","90","120","150","180","240")
colnames(weight_all_max)<-t(calc_t20$max_SL_type[1])
weight_all_max<-cbind.data.frame(Time=row.names(weight_all_max),weight_all_max)
weight_all_max<-melt(weight_all_max, id="Time")
weight_all_max$Time<-as.numeric(levels(weight_all_max$Time))[weight_all_max$Time]

ggplot(weight_all_max, aes(x=Time,y=value,colour=variable)) + geom_line(aes(group=variable),size=0.4) + geom_point(shape=1) + ggtitle("Super Learner Weights over time") + labs(x="time point (minutes)", y="Super Learner Coefficient", sep=" ")

```

```{r, echo=FALSE, eval=TRUE}
weight_all_ave<-t(cbind.data.frame(calc_t20$ave_SL_type[2],calc_t30$ave_SL_type[2],calc_t60$ave_SL_type[2],
                                   calc_t90$ave_SL_type[2],calc_t120$ave_SL_type[2],
                                   calc_t150$ave_SL_type[2],calc_t180$ave_SL_type[2],calc_t240$ave_SL_type[2]))
row.names(weight_all_ave)<-c("20","30","60","90","120","150","180","240")
colnames(weight_all_ave)<-t(calc_t20$ave_SL_type[1])
weight_all_ave<-cbind.data.frame(Time=row.names(weight_all_ave),weight_all_ave)
weight_all_ave<-melt(weight_all_ave, id="Time")
weight_all_ave$Time<-as.numeric(levels(weight_all_ave$Time))[weight_all_ave$Time]

ggplot(weight_all_ave, aes(x=Time,y=value,colour=variable)) + geom_line(aes(group=variable),size=0.4) + geom_point(shape=1) + ggtitle("Super Learner Weights over varying Training Time") + labs(x="Training time (minutes)", y="Super Learner Coefficient", sep=" ") + theme_bw()

```

```{r, results='asis', echo=FALSE}
print(xtable(data.frame(loss_all_t), caption='\\textbf{Risk for all different SLs considered}', digits=10), include.rownames=TRUE,caption.placement = "top", size="\\fontsize{9pt}{10pt}\\selectfont")
```