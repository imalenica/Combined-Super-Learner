---
title: "Test Combined SL: ARIMA-based simulations"
author: "Ivana Malenica"
date: "Spring 2020"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
header-includes:
- \usepackage{graphicx}
- \usepackage{lscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{float}
---

# Load packages and data {-}

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(warn=-1)
suppressMessages(library(xtable))
suppressMessages(library(here))
suppressMessages(library(pROC))
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(reshape2))
suppressMessages(library(forecast))
suppressMessages(library(kableExtra))
suppressMessages(library(sl3))
suppressMessages(library(origami))
suppressMessages(library(data.table))
suppressMessages(library(ck37r))
options(xtable.comment = FALSE)
```

\newpage

# Overview {-}

We may be interested in the performance of the Combined Super Learner with data simulated
using pooled and individual ARIMA fits based on the actual MIMIC dataset. 

# Prepare the data

We only considered patients that had:

* at least 5 hours of data.
* no gaps in time.

\vspace{.2in}

# Create ARIMA models for each patient

We estimate the optimal autoregressive and moving average orders $p$ 
and $q$ based on a chosen information criterion (AICc by default) from a local 
search over a few regions of values. In particular, we fit individual ARIMA models
as well as a pooled ARIMA model estimated from multiple time-series. As such, 
the resuluting models include:

* Pooled model over all samples,
* Individual models for each inidvidual. 

## Examine accuracy of one-step ahead forecasts

```{r, echo = FALSE, message = FALSE, warning = FALSE}
load(here("Simulations/ARIMA_sims/Results/fit_ARIMA_v1.Rdata"))

##Pooled stats
#Pooled vs. assessed on separate models accuracy
acc_all <- rbind.data.frame(fit_v1$fit_pooled$accuracy_pooled, fit_v1$fit_pooled$accuracy)
acc_all$subject_id<-as.numeric(levels(acc_all$subject_id))[acc_all$subject_id]
acc_all[1,1]<-"pooled"
#acc_all %>%
#  kable(format = "latex", booktabs = T, digits = 4, longtable = T,
#        caption = "Accuracy of pooled ARIMA one-step forecasts used for simulation") %>%
#  kable_styling(latex_options = c("striped", "repeat_header"), font_size = 7,
#                position = "center")

##Individual stats
acc_ind <- t(rbind_list(lapply(fit_v1$fit_individuals, function(x){x$accuracy})))
acc_ind <- cbind.data.frame(row.names(acc_ind), acc_ind)
colnames(acc_ind) <- names(acc_all)
row.names(acc_ind) <- NULL
#acc_ind %>%
#  kable(format = "latex", booktabs = T, digits = 4, longtable = T,
#        caption = "Accuracy of ARIMA one-step forecasts used for simulation") %>%
#  kable_styling(latex_options = c("striped", "repeat_header"), font_size = 7,
#                position = "center")

#Combine results to compare:
acc_comb <- merge(x=acc_all[,c("subject_id", "MAE")], 
                  acc_ind[,c("subject_id", "MAE")],  by="subject_id")
names(acc_comb)[2:3] <- c("MAE pooled", "MAE individual")
acc_comb %>%
  kable(format = "latex", booktabs = T, digits = 4, longtable = T,
        caption = "Compare MAE for pooled and individual forecasts") %>%
  kable_styling(latex_options = c("striped", "repeat_header"), font_size = 7,
                position = "center")
#test<-acc_comb[acc_comb$`MAE individual`>acc_comb$`MAE pooled`,]
#acc_comb[which.max(acc_comb$`MAE pooled`-acc_comb$`MAE individual`),]
#acc_comb[which.max(acc_comb$`MAE individual`-acc_comb$`MAE pooled`),]
```

```{r, echo = FALSE, warning = FALSE}

#Example of individual forecast doing better
par(mfrow=c(2,1))
plot_forecast(fit=fit_v1, type = "individual", id = 13569)
plot_forecast(fit=fit_v1, type = "pooled", id = 13569)

#Example of pooled forecast doing better
par(mfrow=c(2,1))
plot_forecast(fit=fit_v1, type = "individual", id = 15631)
plot_forecast(fit=fit_v1, type = "pooled", id = 15631)

```

\normalsize
\newpage

# Simulate from ARIMA models

We use the ARIMA fitted models to simulate 
time series. We simulate from both individual 
trajectories and pooled trajectories, while adding extra noise. 

* By default, the error series is assumed normally distributed and generated 
  using `rnorm`. However, we set `bootstrap=TRUE`, so the residuals are 
  resampled instead. Also, we set `future=TRUE`, so the sample paths are 
  conditional on the data that was used to fit the model. 

* When `future=FALSE` and the model is stationary, the sample paths do not 
  depend on the data at all. When `future=FALSE` and the model is 
  non-stationary, the location of the sample paths is arbitrary, so they all 
  start at the value of the first observation.
  
# Examine the performance of the combined super learner

```{r, eval = FALSE, echo = FALSE, warning = FALSE}


```

