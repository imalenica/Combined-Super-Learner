---
title: "Fit a GLARMA model to MIMIC dataset"
output: pdf_document
---

```{r, echo=FALSE}
library(glarma)
library(forecast)
library(plyr)
library(dplyr)
library(here)
source(here::here("R/CombinedOnlineSL.R"))
source(here::here("R/utils_mimic.R"))
```

```{r}
#Load data:
data<-load(here::here("Data/data.Rdata"))

#Pick 500 samples that have period 1,2 3, 4 and 5:
train_all <- sample_n_t(df, n = 500, t=5)
samples<-unique(train_all$subject_id)

#PROBLEM: How to deal with missing values?
#NAs: sapsi_first,sofa_first, bmi, los_hospital
summary(train_all)
train_all <- train_all[,-c(2,6,7,8,10,12)]

#Convert character to numeric:
#gender, admission_type_descr
train_all$gender <- ifelse(train_all$gender=="M",1,0)

#Create a new outcome:
train_all <- new_Y_sol1(train_all = train_all)

#Specify the covariates and outcome:
covars_wbaseline <- c("gender","age","care_unit",
                      "los_icu","amine","sedation","ventilation","spo2","abpsys",
                      "abpdias","abpmean")
covars <- c("los_icu","amine","sedation","ventilation","spo2","abpsys","abpdias","abpmean")
```

```{r}
### ARIMA
#Issue: this is an interrupted time-series... "Seassonality" in individuals
fit_arima_global <- forecast::auto.arima(train_all$abpmean)

#this is a univariate method, see robustness across individuals
fit<-list()
fit_coef<-list()
counter<-1
for(i in samples){
  sub <- train_all[train_all$subject_id==i,]
  fit[[counter]] <- forecast::auto.arima(sub$abpmean)
  fit_coef[[counter]]<-fit[[counter]]$coef
  counter<-counter+1
}

fit_coef_all<-do.call("rbind.fill", lapply(fit_coef, function(x) data.frame(as.list(x))))
write.csv(fit_coef_all, here::here("Results/ARIMA_fits_n500.csv"))

### Model with glarma
Y<-cbind.data.frame(Y1=train_all$Y1,Y0=1-train_all$Y1)
#X<-data.frame(Intcpt=rep(1,nrow(train_all)), train_all[,covars])
X <- data.frame(Intcpt=rep(1,nrow(train_all)), abpdias=train_all$abpdias, 
                abpsys=train_all$abpsys, abpmean=train_all$abpmean)

#Do not specify any of the lags
#Use binomial distribution to model the counts
#Fisher scoring for estimating the parameters of glarma
#Pearson residuals 
bin_fit<-glarma(y=train_all$Y1, thetaLags = c(1,2,5), X=train_all$abpmean, type="Poi")


```

